// Package template contains CloudFormation resources.
// Main resources
//
// Generated by wetwire-aws import.
package template

import (
	. "github.com/lex00/wetwire-aws-go/intrinsics"
	"github.com/lex00/wetwire-aws-go/resources/kinesis"
	"github.com/lex00/wetwire-aws-go/resources/serverless"
)

var LoggingStream = kinesis.Stream{
	ShardCount: 1,
}

var SiteAPI = serverless.Api{
	DefinitionBody: Transform{Json{
	"Name": "AWS::Include",
	"Parameters": Json{
		"Location": "./api.yaml",
	},
}},
	EndpointConfiguration: "REGIONAL",
	MethodSettings: []any{Json{
	"DataTraceEnabled": true,
	"HttpMethod": "*",
	"LoggingLevel": "INFO",
	"MetricsEnabled": true,
	"ResourcePath": "/*",
	"ThrottlingBurstLimit": 1000,
	"ThrottlingRateLimit": 2000,
}, Json{
	"HttpMethod": "GET",
	"ResourcePath": "/{linkId}",
	"ThrottlingBurstLimit": 4000,
	"ThrottlingRateLimit": 10000,
}},
	StageName: "Prod",
	TracingEnabled: true,
}

var LoggingProcessorEnvironment = serverless.Function_Environment{
	Variables: Json{"TABLE_NAME": LinkTable},
}

var LoggingProcessor = serverless.Function{
	CodeUri: "src/analytics/",
	Environment: &LoggingProcessorEnvironment,
	Events: Json{
	"KinesisTrigger": Json{
	"Properties": Json{
	"BisectBatchOnFunctionError": true,
	"DestinationConfig": Json{
	"OnFailure": Json{
	"Destination": LoggingDLQ.Arn,
},
},
	"MaximumBatchingWindowInSeconds": 15,
	"MaximumRetryAttempts": 3,
	"StartingPosition": "TRIM_HORIZON",
	"Stream": LoggingStream.Arn,
},
	"Type": "Kinesis",
},
},
	Handler: "app.handler",
	MemorySize: 1024,
	Policies: []any{Json{
	"DynamoDBWritePolicy": Json{
	"TableName": LinkTable,
},
}, Json{
	"SQSSendMessagePolicy": Json{
	"QueueName": LoggingDLQ.QueueName,
},
}},
	Runtime: "nodejs16.x",
	Timeout: 45,
	Tracing: "Active",
}
