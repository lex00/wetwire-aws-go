// Package template contains CloudFormation resources.
// Main resources
//
// Generated by wetwire-aws import.
package template

import (
	. "github.com/lex00/wetwire-aws-go/intrinsics"
	"github.com/lex00/wetwire-aws-go/resources/serverless"
)

var downloadSignerLambda = serverless.Function{
	CodeUri: "lambda/downloadSigner/",
	Policies: []any{Json{
	"S3ReadPolicy": Json{
	"BucketName": storageBucket,
},
}},
}

var uploadSignerLambda = serverless.Function{
	CodeUri: "lambda/uploadSigner/",
	Policies: []any{Json{
	"S3WritePolicy": Json{
	"BucketName": storageBucket,
},
}},
}

var httpApi = serverless.HttpApi{
	DefinitionBody: Json{
	"info": Json{
	"title": "Signed URL Generator - Built with AWS SAM",
},
	"openapi": "3.0.1",
	"paths": Json{
	"/": Json{
	"post": Json{
	"responses": Json{
	"default": Json{
	"description": "Step Function Response",
},
},
	"x-amazon-apigateway-integration": Json{
	"connectionType": "INTERNET",
	"credentials": httpApiRole.Arn,
	"integrationSubtype": "StepFunctions-StartSyncExecution",
	"payloadFormatVersion": "1.0",
	"requestParameters": Json{
	"Input": "$request.body",
	"StateMachineArn": urlStateMachine.Arn,
},
	"type": "aws_proxy",
},
},
},
},
},
}

var fetchedShortUrlLambda = serverless.Function{
	CodeUri: "lambda/fetchShortUrl/",
	Events: Json{
	"ApiEvent": Json{
	"Properties": Json{
	"ApiId": httpApi,
	"Method": "GET",
	"Path": "/{id}",
},
	"Type": "HttpApi",
},
},
	Policies: Json{
	"DynamoDBReadPolicy": Json{
	"TableName": urlTable,
},
},
}

var urlStateMachine = serverless.StateMachine{
	Definition: Json{
	"StartAt": "Generate Signed URLs",
	"States": Json{
	"Generate Signed URLs": Json{
	"Branches": []any{Json{
	"StartAt": "GetUploadSignedUrl",
	"States": Json{
	"GetUploadSignedUrl": Json{
	"End": true,
	"Parameters": Json{
	"FunctionName": "${GetUploadSignerFunction}",
	"Payload.$": "$",
},
	"Resource": "arn:aws:states:::lambda:invoke",
	"ResultPath": "$.UploadSignResults",
	"Retry": []any{Json{
	"BackoffRate": 2,
	"ErrorEquals": []any{"Lambda.ServiceException", "Lambda.AWSLambdaException", "Lambda.SdkClientException"},
	"IntervalSeconds": 2,
	"MaxAttempts": 6,
}},
	"Type": "Task",
},
},
}, Json{
	"StartAt": "GetDownloadSignedUrl",
	"States": Json{
	"GetDownloadSignedUrl": Json{
	"Next": "WriteToDynamoDB",
	"OutputPath": "$",
	"Parameters": Json{
	"FunctionName": "${GetDownloadSignerFunction}",
	"Payload.$": "$",
},
	"Resource": "arn:aws:states:::lambda:invoke",
	"ResultPath": "$.DownloadSignResults",
	"Retry": []any{Json{
	"BackoffRate": 2,
	"ErrorEquals": []any{"Lambda.ServiceException", "Lambda.AWSLambdaException", "Lambda.SdkClientException"},
	"IntervalSeconds": 2,
	"MaxAttempts": 6,
}},
	"Type": "Task",
},
	"WriteToDynamoDB": Json{
	"End": true,
	"OutputPath": "$",
	"Parameters": Json{
	"Item": Json{
	"TTL": Json{
	"N.$": "$.DownloadSignResults.Payload.ttl",
},
	"id": Json{
	"S.$": "$.DownloadSignResults.Payload.id",
},
	"signedUrl": Json{
	"S.$": "$.DownloadSignResults.Payload.signedUrl",
},
},
	"TableName": "${DDBTable}",
},
	"Resource": "${DDBPutItem}",
	"ResultPath": "$.DynamoResults",
	"Type": "Task",
},
},
}},
	"Comment": "Fetches a signed upload and download URL for the given Key",
	"Next": "formatResults",
	"Type": "Parallel",
},
	"formatResults": Json{
	"End": true,
	"Parameters": Json{
	"DownloadShortId.$": "$[1].DownloadSignResults.Payload.id",
	"DownloadUrl.$": "$[1].DownloadSignResults.Payload.signedUrl",
	"UploadUrl.$": "$[0].UploadSignResults.Payload.signedUrl",
},
	"Type": "Pass",
},
},
	"TimeoutSeconds": 30,
},
	DefinitionSubstitutions: Json{
	"DDBPutItem": Sub{String: "arn:${AWS::Partition}:states:::dynamodb:putItem"},
	"DDBTable": urlTable,
	"GetDownloadSignerFunction": downloadSignerLambda.Arn,
	"GetUploadSignerFunction": uploadSignerLambda.Arn,
},
	Policies: []any{Json{
	"DynamoDBWritePolicy": Json{
	"TableName": urlTable,
},
}, Json{
	"LambdaInvokePolicy": Json{
	"FunctionName": uploadSignerLambda,
},
}, Json{
	"LambdaInvokePolicy": Json{
	"FunctionName": downloadSignerLambda,
},
}},
	Tracing: Json{
	"Enabled": true,
},
	Type_: "EXPRESS",
}
