// Package template contains CloudFormation resources.
// Main resources
//
// Generated by wetwire-aws import.
package template

import (
	. "github.com/lex00/wetwire-aws-go/intrinsics"
	"github.com/lex00/wetwire-aws-go/resources/appsync"
)

var AppSyncApi = appsync.GraphQLApi{
	AuthenticationType: "API_KEY",
	Name: "SingleTableApi",
	XrayEnabled: true,
}

var AppSyncApiKey = appsync.ApiKey{
	ApiId: AppSyncApi.ApiId,
}

var AppSyncSchema = appsync.GraphQLSchema{
	ApiId: AppSyncApi.ApiId,
	Definition: `type Parent{
  PK: String!
  SK: String!
  children: [Child]
  data: String!
  type: String!
}

type Child {
  PK: String!
  SK: String!
  data: String!
  type: String!
}

type Mutation {
  createParentItem(
    PK: ID!,
    SK: String!,
    data: String!,
    type: String!
  ): Parent

  createChildItem(
    PK: ID!,
    SK: String!,
    data: String!,
    type: String!
  ): Child
}

type Query{
  getParentWithChildren(PK: ID!): Parent
}
`,
}

var DDBDataSourceDynamoDBConfig = appsync.DataSource_DynamoDBConfig{
	AwsRegion: AWS_REGION,
	TableName: DDBTable,
}

var DDBDataSource = appsync.DataSource{
	ApiId: AppSyncApi.ApiId,
	Description: "The Single Table AppSync Data Source",
	DynamoDBConfig: &DDBDataSourceDynamoDBConfig,
	Name: "SingleTableDataSource",
	ServiceRoleArn: DDBRole.Arn,
	Type_: "AMAZON_DYNAMODB",
}

var CreateChildMutationResolver = appsync.Resolver{
	ApiId: AppSyncApi.ApiId,
	DataSourceName: DDBDataSource.Name,
	FieldName: "createChildItem",
	RequestMappingTemplate: `{
  "version": "2018-05-29",
  "operation": "PutItem",
  "key": {
    "PK": $util.dynamodb.toDynamoDBJson($ctx.args.PK),
    "SK": $util.dynamodb.toDynamoDBJson($ctx.args.SK)
  },
  "attributeValues": {
    "data": $util.dynamodb.toDynamoDBJson($ctx.args.data),
    "type": $util.dynamodb.toDynamoDBJson($ctx.args.type)
  }
}
`,
	ResponseMappingTemplate: "$util.toJson($ctx.result)",
	TypeName: "Mutation",
}

var CreateParentMutationResolver = appsync.Resolver{
	ApiId: AppSyncApi.ApiId,
	DataSourceName: DDBDataSource.Name,
	FieldName: "createParentItem",
	RequestMappingTemplate: `{
  "version": "2018-05-29",
  "operation": "PutItem",
  "key": {
    "PK": $util.dynamodb.toDynamoDBJson($ctx.args.PK),
    "SK": $util.dynamodb.toDynamoDBJson($ctx.args.SK)
  },
  "attributeValues": {
    "data": $util.dynamodb.toDynamoDBJson($ctx.args.data),
    "type": $util.dynamodb.toDynamoDBJson($ctx.args.type)
  }
}
`,
	ResponseMappingTemplate: "$util.toJson($ctx.result)",
	TypeName: "Mutation",
}

var GetParentAndChildResolver = appsync.Resolver{
	ApiId: AppSyncApi.ApiId,
	DataSourceName: DDBDataSource.Name,
	FieldName: "getParentWithChildren",
	RequestMappingTemplate: `{
  "version" : "2017-02-28",
  "operation" : "Query",
  "query" : {
    "expression": "PK = :pk",
    "expressionValues" : {
        ":pk" : $util.dynamodb.toDynamoDBJson($ctx.args.PK)
    }
  }
}
`,
	ResponseMappingTemplate: `#set($children = [])

#foreach($item in $ctx.result.items)
  #if($item['type'] == "parent")
    #set($PK = $item['PK'])
    #set($SK = $item['SK'])
    #set($data = $item['data'])
    #set($type = $item['type'])
  #end
  #if($item['type'] == "child")
    $util.qr($children.add($item))
  #end
#end

{
  "PK": "${PK}",
    "SK": "${SK}",
    "children": $utils.toJson($children),
    "data": "${data}",
    "type": "${type}"
}
`,
	TypeName: "Query",
}
