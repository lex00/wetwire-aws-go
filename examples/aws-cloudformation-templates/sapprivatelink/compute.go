// Package sapprivatelink contains CloudFormation resources.
// Compute resources: EC2, Lambda, ECS, etc.
//
// Generated by wetwire-aws import.
package sapprivatelink

import (
	"github.com/lex00/cloudformation-schema-go/enums"
	. "github.com/lex00/wetwire-aws-go/intrinsics"
	"github.com/lex00/wetwire-aws-go/resources/lambda"
)

var ASCPrivateLinkLambdaFunctionVpcConfig = &lambda.Function_VpcConfig{
	SecurityGroupIds: SecurityGroups,
	SubnetIds: Subnets,
}

var ASCPrivateLinkLambdaFunctionCode = lambda.Function_Code{
	ZipFile: SubWithMap{String: "import boto3\nimport cfnresponse\nimport logging\ndef handler(event, context):\n  print('Receive event: {} and context: {}'.format(str(event), str(context)))\n  responseData = {}\n  eventType = event['RequestType'].strip()\n  props = event['ResourceProperties']\n  try:\n    if eventType in ('Create'):\n      match props['Action']:\n        case 'EnablePrivateDNS':\n          dnsClient = boto3.client('route53')\n          ec2Client = boto3.client('ec2')\n          serviceId = props['ServiceId']\n          domainName = props['DomainName']\n          hostedZoneId = props['HostedZoneId']\n          ec2Client.modify_vpc_endpoint_service_configuration(ServiceId=serviceId, PrivateDnsName=domainName)\n          validationRecord = ec2Client.describe_vpc_endpoint_service_configurations(ServiceIds=[serviceId])['ServiceConfigurations'][0]['PrivateDnsNameConfiguration']\n          dnsClient.change_resource_record_sets(\n            HostedZoneId=hostedZoneId,\n            ChangeBatch={\n              'Changes': [\n                {\n                  'Action': 'UPSERT',\n                  'ResourceRecordSet': {\n                    'Type': validationRecord['Type'],\n                    'Name': '{}.{}'.format(validationRecord['Name'], domainName[2:] if domainName.startswith('*') else domainName),\n                    'ResourceRecords': [{'Value': '\"{}\"'.format(validationRecord['Value'])}],\n                    'TTL': 300\n                  }\n                }\n              ]\n            }\n          )\n        case _:\n          raise Exception('Unsupported action')\n    else:\n      print('Skip on resource UPDATE and DELETE')\n    cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)\n  except Exception as e:\n    logging.exception(e)\n    cfnresponse.send(event, context, cfnresponse.FAILED, responseData)\n", Variables: lambda.Function_Code{
	Region: AWS_REGION,
}},
}

var ASCPrivateLinkLambdaFunction = lambda.Function{
	Code: ASCPrivateLinkLambdaFunctionCode,
	Description: "Lambda function to help with private link infrastructure setup",
	Handler: "index.handler",
	Role: ASCPrivateLinkLambdaRole.Arn,
	Runtime: enums.LambdaRuntimePython312,
	Timeout: 900,
	VpcConfig: ASCPrivateLinkLambdaFunctionVpcConfig,
}
