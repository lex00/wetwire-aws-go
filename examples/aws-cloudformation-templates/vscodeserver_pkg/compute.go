// Package vscodeserver_pkg contains CloudFormation resources.
// Compute resources: EC2, Lambda, ECS, etc.
//
// Generated by wetwire-aws import.
package vscodeserver_pkg

import (
	. "github.com/lex00/wetwire-aws-go/intrinsics"
	"github.com/lex00/wetwire-aws-go/resources/ec2"
)

var ServerBlockDeviceMappingDevxvdaEbs = ec2.Instance_Ebs{
	VolumeSize: 128,
}

var ServerTagName = Tag{
	Key: "Name",
	Value: "vscode-server",
}

var ServerBlockDeviceMappingDevxvda = ec2.Instance_BlockDeviceMapping{
	DeviceName: "/dev/xvda",
	Ebs: &ServerBlockDeviceMappingDevxvdaEbs,
}

var Server = ec2.Instance{
	AvailabilityZone: Select{Index: 0, List: GetAZs{}},
	BlockDeviceMappings: []any{ServerBlockDeviceMappingDevxvda},
	IamInstanceProfile: InstanceProfile,
	ImageId: LatestAMI,
	InstanceType: InstanceType,
	SecurityGroupIds: []any{InstanceSecurityGroup.GroupId},
	SubnetId: NetworkPublicSubnet1.SubnetId,
	Tags: []any{ServerTagName},
	UserData: Base64{Sub{String: "#!/bin/bash\n\nset -eou pipefail\n\nlocal_ip=$(ec2-metadata | grep \"^local-ipv4: \" | cut -d \" \" -f 2)\n\n# Install the latest code-server from coder.com (not from yum)\nexport HOME=/root \ncurl -fsSL https://code-server.dev/install.sh | bash\n\n# Install cfn-signal\nyum install -y aws-cfn-bootstrap\n\n#Install argon2 for hashing the vscode server password\nyum install -y argon2\n\n# Configure the service\ntee /etc/systemd/system/code-server.service <<EOF\n[Unit]\nDescription=Start code server\n\n[Service]\nExecStart=/usr/bin/code-server --port 8080 --host $local_ip\nRestart=always\nType=simple\nUser=ec2-user\n\n[Install]\nWantedBy = multi-user.target\nEOF\n\n# Get the password from secrets manager\nsecret_string=$(aws secretsmanager get-secret-value --secret-id ${SecretName} | jq -r \".SecretString\")\n\n# Hash the password\nhashed_password=$(echo -n $secret_string | argon2 saltiness -e)\n\n# Install Node.js\nsudo -u ec2-user -i <<EOF\ncurl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash\nsource .bashrc\nnvm install 20.11.0\nnvm use 20.11.0\nEOF\n\n# Save the config file\nmkdir -p /home/ec2-user/.config/code-server\nsudo tee /home/ec2-user/.config/code-server/config.yaml <<ENDCONFIG\ncert: false\nauth: password\nhashed-password: \"$hashed_password\"\nuser-data-dir: /home/ec2-user\nENDCONFIG\n\nchown -R ec2-user /home/ec2-user/.config\n\nsystemctl daemon-reload\nsystemctl enable --now code-server\n\n# Tell CloudFormation we're ready to go\n# This is a variable for the Sub intrisic function, not a bash variable\ncfn-signal -s true --stack ${AWS::StackName} --resource Server --region ${AWS::Region}"}},
}
