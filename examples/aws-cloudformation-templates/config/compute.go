// Package config_stack contains CloudFormation resources.
// Compute resources: EC2, Lambda, ECS, etc.
//
// Generated by wetwire-aws import.
package config_stack

import (
	"github.com/lex00/cloudformation-schema-go/enums"
	. "github.com/lex00/wetwire-aws-go/intrinsics"
	"github.com/lex00/wetwire-aws-go/resources/ec2"
	"github.com/lex00/wetwire-aws-go/resources/lambda"
)

var Ec2Volume = ec2.Volume{
	AutoEnableIO: Ec2VolumeAutoEnableIO,
	AvailabilityZone: Select{0, GetAZs{}},
	Size: "5",
	Tags: []any{},
}

var VolumeAutoEnableIOComplianceCheckCode = lambda.Function_Code{
	ZipFile: "var aws  = require('aws-sdk');\nvar config = new aws.ConfigService();\nvar ec2 = new aws.EC2();\nexports.handler = function(event, context) {\n    var compliance = evaluateCompliance(event, function(compliance, event) {\n        var configurationItem = JSON.parse(event.invokingEvent).configurationItem;\n        var putEvaluationsRequest = {\n            Evaluations: [{\n                ComplianceResourceType: configurationItem.resourceType,\n                ComplianceResourceId: configurationItem.resourceId,\n                ComplianceType: compliance,\n                OrderingTimestamp: configurationItem.configurationItemCaptureTime\n            }],\n            ResultToken: event.resultToken\n        };\n        config.putEvaluations(putEvaluationsRequest, function(err, data) {\n            if (err) context.fail(err);\n            else context.succeed(data);\n        });\n    });\n};\nfunction evaluateCompliance(event, doReturn) {\n    var configurationItem = JSON.parse(event.invokingEvent).configurationItem;\n    var status = configurationItem.configurationItemStatus;\n    if (configurationItem.resourceType !== 'AWS::EC2::Volume' || event.eventLeftScope || (status !== 'OK' && status !== 'ResourceDiscovered'))\n        doReturn('NOT_APPLICABLE', event);\n    else ec2.describeVolumeAttribute({VolumeId: configurationItem.resourceId, Attribute: 'autoEnableIO'}, function(err, data) {\n        if (err) context.fail(err);\n        else if (data.AutoEnableIO.Value) doReturn('COMPLIANT', event);\n        else doReturn('NON_COMPLIANT', event);\n    });\n}\n",
}

var VolumeAutoEnableIOComplianceCheck = lambda.Function{
	Code: VolumeAutoEnableIOComplianceCheckCode,
	Handler: "index.handler",
	Role: LambdaExecutionRole.Arn,
	Runtime: enums.LambdaRuntimeNodejs20X,
	Timeout: "30",
}

var ConfigPermissionToCallLambda = lambda.Permission{
	Action: "lambda:InvokeFunction",
	FunctionName: VolumeAutoEnableIOComplianceCheck.Arn,
	Principal: "config.amazonaws.com",
}
