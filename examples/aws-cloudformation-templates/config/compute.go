// Package config_stack contains CloudFormation resources.
// Compute resources: EC2, Lambda, ECS, etc.
//
// Generated by wetwire-aws import.
package config_stack

import (
	"github.com/lex00/cloudformation-schema-go/enums"
	. "github.com/lex00/wetwire-aws-go/intrinsics"
	"github.com/lex00/wetwire-aws-go/resources/ec2"
	"github.com/lex00/wetwire-aws-go/resources/lambda"
)

var Ec2Volume = ec2.Volume{
	AutoEnableIO: Ec2VolumeAutoEnableIO,
	AvailabilityZone: Select{Index: 0, List: GetAZs{}},
	Size: "5",
	Tags: []any{},
}

var VolumeAutoEnableIOComplianceCheckCode = lambda.Function_Code{
	ZipFile: `var aws  = require('aws-sdk');
var config = new aws.ConfigService();
var ec2 = new aws.EC2();
exports.handler = function(event, context) {
    var compliance = evaluateCompliance(event, function(compliance, event) {
        var configurationItem = JSON.parse(event.invokingEvent).configurationItem;
        var putEvaluationsRequest = {
            Evaluations: [{
                ComplianceResourceType: configurationItem.resourceType,
                ComplianceResourceId: configurationItem.resourceId,
                ComplianceType: compliance,
                OrderingTimestamp: configurationItem.configurationItemCaptureTime
            }],
            ResultToken: event.resultToken
        };
        config.putEvaluations(putEvaluationsRequest, function(err, data) {
            if (err) context.fail(err);
            else context.succeed(data);
        });
    });
};
function evaluateCompliance(event, doReturn) {
    var configurationItem = JSON.parse(event.invokingEvent).configurationItem;
    var status = configurationItem.configurationItemStatus;
    if (configurationItem.resourceType !== 'AWS::EC2::Volume' || event.eventLeftScope || (status !== 'OK' && status !== 'ResourceDiscovered'))
        doReturn('NOT_APPLICABLE', event);
    else ec2.describeVolumeAttribute({VolumeId: configurationItem.resourceId, Attribute: 'autoEnableIO'}, function(err, data) {
        if (err) context.fail(err);
        else if (data.AutoEnableIO.Value) doReturn('COMPLIANT', event);
        else doReturn('NON_COMPLIANT', event);
    });
}
`,
}

var VolumeAutoEnableIOComplianceCheck = lambda.Function{
	Code: VolumeAutoEnableIOComplianceCheckCode,
	Handler: "index.handler",
	Role: LambdaExecutionRole.Arn,
	Runtime: enums.LambdaRuntimeNodejs20X,
	Timeout: "30",
}

var ConfigPermissionToCallLambda = lambda.Permission{
	Action: "lambda:InvokeFunction",
	FunctionName: VolumeAutoEnableIOComplianceCheck.Arn,
	Principal: "config.amazonaws.com",
}
