// Package cloudfront_stack contains CloudFormation resources.
// Compute resources: EC2, Lambda, ECS, etc.
//
// Generated by wetwire-aws import.
package cloudfront_stack

import (
	"github.com/lex00/cloudformation-schema-go/enums"
	. "github.com/lex00/wetwire-aws-go/intrinsics"
	"github.com/lex00/wetwire-aws-go/resources/ec2"
	"github.com/lex00/wetwire-aws-go/resources/lambda"
)

var EC2InstanceBlockDeviceMappingDevsda1Ebs = ec2.Instance_Ebs{
	VolumeSize: BootVolSize,
	VolumeType: BootVolType,
}

var EC2InstanceTagEnvironment = Tag{
	Key: "Environment",
	Value: Environment,
}

var EC2InstanceTagName = Tag{
	Key: "Name",
	Value: Sub{String: "${AppName}-${Environment}-ec2-instance"},
}

var EC2InstanceBlockDeviceMappingDevsda1 = ec2.Instance_BlockDeviceMapping{
	DeviceName: "/dev/sda1",
	Ebs: EC2InstanceBlockDeviceMappingDevsda1Ebs,
}

var EC2Instance = ec2.Instance{
	BlockDeviceMappings: []any{EC2InstanceBlockDeviceMappingDevsda1},
	ImageId: EC2ImageId,
	InstanceType: EC2InstanceType,
	KeyName: KeyPairName,
	SecurityGroupIds: []any{EC2InstanceSG, ALBExternalAccessSG},
	SubnetId: PublicSubnetId1,
	Tags: []any{EC2InstanceTagName, EC2InstanceTagEnvironment},
}

var LambdaEdgeFunctionCode = lambda.Function_Code{
	ZipFile: `'use strict';

 exports.handler = (event, context, callback) => {
    console.log('Adding additional headers to CloudFront response.');

    const response = event.Records[0].cf.response;
    response.headers['strict-transport-security'] = [{
    key: 'Strict-Transport-Security',
    value: 'max-age=86400; includeSubdomains; preload',
    }];
    response.headers['x-content-type-options'] = [{
    key: 'X-Content-Type-Options',
    value: 'nosniff',
    }];
    response.headers['x-frame-options'] = [{
        key:   'X-Frame-Options',
        value: "DENY"
    }];
    response.headers['content-security-policy'] = [{
        key:   'Content-Security-Policy',
        value: "default-src 'none'; img-src 'self'; script-src 'self'; style-src 'self'; object-src 'none'"
    }];
    response.headers['x-xss-protection'] = [{
        key:   'X-XSS-Protection',
        value: "1; mode=block"
    }];
    response.headers['referrer-policy'] = [{
        key:   'Referrer-Policy',
        value: "same-origin"
    }];
    callback(null, response);
  };
`,
}

var LambdaEdgeFunction = lambda.Function{
	Code: LambdaEdgeFunctionCode,
	Description: "A custom Lambda@Edge function for serving custom headers from CloudFront Distribution",
	FunctionName: Sub{String: "${AppName}-lambda-edge-${Environment}"},
	Handler: "index.handler",
	MemorySize: 128,
	Role: LambdaEdgeIAMRole.Arn,
	Runtime: enums.LambdaRuntimeNodejs20X,
	Timeout: 5,
}

var LambdaEdgeVersion = lambda.Version{
	FunctionName: LambdaEdgeFunction,
}
