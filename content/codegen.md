---
title: "Codegen"
---

This document describes the Go-specific implementation of the wetwire code generation workflow.

---

## Overview

The code generator produces Go types for all AWS CloudFormation resource types. It fetches the CloudFormation Resource Specification, parses it, and generates typed Go structs for each resource.

---

## Directory Structure

```
wetwire-aws-go/
├── codegen/
│   ├── main.go              # Entry point: go run ./codegen
│   ├── parse.go             # Parse CloudFormation spec into services
│   ├── generate.go          # Generate Go files from parsed services
│   ├── sam_spec.go          # Static SAM resource definitions
│   └── sam_codegen_test.go  # SAM generation tests
│
├── resources/               # GENERATED (committed)
│   ├── s3/
│   │   ├── bucket.go        # S3::Bucket resource and property types
│   │   ├── accesspoint.go   # S3::AccessPoint
│   │   └── ...
│   ├── dynamodb/
│   │   ├── table.go
│   │   └── ...
│   ├── lambda/              # No underscore (not a reserved word in Go)
│   ├── serverless/          # SAM resources
│   └── ...                  # 264 service directories
│
└── go.mod                   # Module definition
```

---

## CLI Usage

```bash
# Generate all resource types (from repo root)
go run ./codegen

# Generate only a specific service
go run ./codegen --service s3

# Preview what would be generated
go run ./codegen --dry-run

# Force regeneration (bypass cache)
go run ./codegen --force
```

---

## CloudFormation Specification

**Source URL:** `https://d1uauaxba7bl26.cloudfront.net/latest/gzip/CloudFormationResourceSpecification.json`

The specification is fetched via the `cloudformation-schema-go` dependency package.

### What the Spec Provides

- **Resource Types**: `AWS::S3::Bucket`, `AWS::Lambda::Function`, etc.
- **Property Types**: Nested structures like `BucketEncryption`, `KeySchema`
- **Attributes**: Values retrievable via `!GetAtt` (e.g., `Arn`, `DomainName`)
- **Required Fields**: Which properties are mandatory

### Enum Values

Enum values (like `BillingMode = "PROVISIONED" | "PAY_PER_REQUEST"`) come from the `cloudformation-schema-go/enums` package, which extracts them from botocore service models.

---

## Generation Pipeline

```
┌─────────────────────────────────────────────────────────────┐
│                   Code Generation Pipeline                    │
│                                                               │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────┐   │
│  │    FETCH    │ ─▶ │    PARSE    │ ─▶ │    GENERATE     │   │
│  └─────────────┘    └─────────────┘    └─────────────────┘   │
│                                                               │
│  cloudformation-   Parse into        Generate Go files       │
│  schema-go         Service structs   to resources/           │
│  downloads spec                                               │
└─────────────────────────────────────────────────────────────┘
```

### Stage 1: Fetch

The `cloudformation-schema-go` package handles fetching:

```go
cfnSpec, err := spec.FetchSpec(&spec.FetchOptions{Force: forceRegen})
```

It downloads and caches the CloudFormation specification.

### Stage 2: Parse

The `parseSpec()` function organizes resources by service:

```go
services := parseSpec(cfnSpec, serviceFilter)
```

Each service contains:
- Resources (e.g., `Bucket`, `AccessPoint`)
- Property types (e.g., `Bucket_ServerSideEncryptionRule`)
- Attributes (e.g., `Arn`, `DomainName`)

### Stage 3: Generate

The `generateCode()` function creates Go files:

```go
stats, err := generateCode(services, outputDir, dryRun)
```

For each service, it generates:
- One file per resource (e.g., `bucket.go`)
- Property types inline with the resource
- Enum constants from botocore

---

## SAM Resources

SAM (Serverless Application Model) resources are not part of the CloudFormation spec. They're defined statically in `sam_spec.go`:

```go
var SAMSpec = &Service{
    Name: "serverless",
    Resources: []*Resource{
        {Name: "Function", ...},
        {Name: "Api", ...},
        {Name: "HttpApi", ...},
        // ... 9 SAM resource types
    },
}
```

SAM resources are added to the generation pipeline when no service filter is specified.

---

## Generated Code Structure

Each resource file includes:

1. **Header comment** with generation metadata
2. **Package declaration**
3. **Import statements**
4. **Resource struct** with `ResourceType()` method
5. **Property type structs** for nested properties

### Example: s3/bucket.go

```go
// Code generated by wetwire-aws codegen. DO NOT EDIT.
// Source: CloudFormation Resource Specification
// Generated: 2026-01-06T21:34:23-07:00

package s3

import (
    wetwire "github.com/lex00/wetwire-aws-go"
)

// Bucket represents AWS::S3::Bucket.
type Bucket struct {
    // Attributes for Fn::GetAtt
    Arn                       wetwire.AttrRef `json:"-"`
    DomainName                wetwire.AttrRef `json:"-"`
    DualStackDomainName       wetwire.AttrRef `json:"-"`
    RegionalDomainName        wetwire.AttrRef `json:"-"`
    WebsiteURL                wetwire.AttrRef `json:"-"`

    // Properties
    BucketName                any `json:"BucketName,omitempty"`
    BucketEncryption          any `json:"BucketEncryption,omitempty"`
    // ... more properties
}

// ResourceType returns the CloudFormation resource type.
func (r Bucket) ResourceType() string {
    return "AWS::S3::Bucket"
}

// Bucket_ServerSideEncryptionRule represents the property type.
type Bucket_ServerSideEncryptionRule struct {
    BucketKeyEnabled              any `json:"BucketKeyEnabled,omitempty"`
    ServerSideEncryptionByDefault any `json:"ServerSideEncryptionByDefault,omitempty"`
}
```

---

## Property Type Registry

The generator also creates a registry file that maps CloudFormation property type names to Go types. This is used by the importer.

```go
// Generated in resources/registry.go
var PropertyTypeRegistry = map[string]func() any{
    "AWS::S3::Bucket.ServerSideEncryptionRule": func() any {
        return &s3.Bucket_ServerSideEncryptionRule{}
    },
    // ...
}
```

---

## Type Mapping

| CloudFormation Type | Go Type |
|---------------------|---------|
| `String` | `any` (allows intrinsics) |
| `Integer` | `any` (allows intrinsics) |
| `Boolean` | `any` (allows intrinsics) |
| `Json` | `any` |
| `List` | `[]any` |
| `Map` | `map[string]any` |
| Property Type | Struct (e.g., `Bucket_ServerSideEncryptionRule`) |

Note: Properties use `any` to support CloudFormation intrinsic functions (Ref, GetAtt, Sub, etc.) as values.

---

## Validation

After generation, verify the output:

```bash
# Check syntax
go build ./resources/...

# Run tests
go test ./...

# Run CI checks
./scripts/ci.sh
```

---

## Regeneration

To regenerate all resources from the latest CloudFormation spec:

```bash
# From repo root
go run ./codegen --force

# Verify
go build ./...
go test ./...

# Commit if successful
git add resources/
git commit -m "chore: regenerate from CloudFormation spec vX.X.X"
```

---

## Dependencies

The code generator relies on:

| Package | Purpose |
|---------|---------|
| `cloudformation-schema-go` | Fetch and parse CloudFormation spec |
| `cloudformation-schema-go/enums` | Enum values from botocore |

---

## See Also

- [Developer Guide](DEVELOPERS.md) - Development workflow
- [Internals](INTERNALS.md) - Architecture details
- [Versioning](VERSIONING.md) - Version management
