package main

import (
	"fmt"
	"go/format"
	"os"
	"path/filepath"
	"sort"
	"strings"
	"time"
	"unicode"

	"github.com/lex00/cloudformation-schema-go/enums"
)

// generateEnumsFile generates enums.go with typed enum constants for a service.
func generateEnumsFile(svc *Service, svcDir string, dryRun bool, stats *GenerationStats) error {
	enumNames := enums.GetEnumNames(svc.Name)
	if len(enumNames) == 0 {
		return nil
	}

	var buf strings.Builder
	buf.WriteString("// Code generated by wetwire-aws codegen. DO NOT EDIT.\n")
	buf.WriteString("// Source: cloudformation-schema-go/enums\n")
	buf.WriteString(fmt.Sprintf("// Generated: %s\n\n", time.Now().Format(time.RFC3339)))
	buf.WriteString(fmt.Sprintf("package %s\n", svc.Name))

	// Sort enum names for deterministic output
	sort.Strings(enumNames)

	for _, enumName := range enumNames {
		values := enums.GetAllowedValues(svc.Name, enumName)
		if len(values) == 0 {
			continue
		}

		buf.WriteString(fmt.Sprintf("\n// %s represents valid values for %s.\n", enumName, enumName))
		buf.WriteString(fmt.Sprintf("type %s string\n\n", enumName))
		buf.WriteString("const (\n")

		for _, val := range values {
			constName := enumConstName(enumName, val)
			buf.WriteString(fmt.Sprintf("\t%s %s = %q\n", constName, enumName, val))
		}

		buf.WriteString(")\n")
	}

	// Format the code
	formatted, err := format.Source([]byte(buf.String()))
	if err != nil {
		formatted = []byte(buf.String()) // Use unformatted if formatting fails
	}

	enumsFile := filepath.Join(svcDir, "enums.go")
	if dryRun {
		fmt.Printf("Would write: %s (%d enums)\n", enumsFile, len(enumNames))
		return nil
	}

	if err := os.WriteFile(enumsFile, formatted, 0644); err != nil {
		return err
	}
	stats.FilesWritten++

	return nil
}

// enumConstName generates a Go constant name from an enum type and value.
// Examples:
//   - ("Runtime", "python3.12") -> "RuntimePython312"
//   - ("StorageClass", "STANDARD_IA") -> "StorageClassStandardIa"
//   - ("BucketCannedACL", "public-read") -> "BucketCannedACLPublicRead"
//   - ("ServerSideEncryption", "aws:kms") -> "ServerSideEncryptionAwsKms"
//   - ("Event", "s3:ObjectCreated:*") -> "EventS3ObjectcreatedAll"
//   - ("StandardUnit", "Bytes/Second") -> "StandardUnitBytesPerSecond"
func enumConstName(typeName, value string) string {
	// Split value by common separators and capitalize each part
	var result strings.Builder
	result.WriteString(typeName)

	// Replace common separators with spaces for splitting
	normalized := strings.ReplaceAll(value, "-", " ")
	normalized = strings.ReplaceAll(normalized, "_", " ")
	normalized = strings.ReplaceAll(normalized, ".", " ")
	normalized = strings.ReplaceAll(normalized, ":", " ")
	normalized = strings.ReplaceAll(normalized, "(", " ")
	normalized = strings.ReplaceAll(normalized, ")", " ")
	// Replace special characters with meaningful words
	normalized = strings.ReplaceAll(normalized, "*", "All")
	normalized = strings.ReplaceAll(normalized, "/", "Per")

	for _, part := range strings.Fields(normalized) {
		// Capitalize first letter, lowercase rest
		for i, r := range part {
			if i == 0 {
				result.WriteRune(unicode.ToUpper(r))
			} else {
				result.WriteRune(unicode.ToLower(r))
			}
		}
	}

	return result.String()
}
